
//&После("ДобавитьКомандыПечати")
//Процедура ЦППК_ДобавитьКомандыПечати(КомандыПечати)
//	
//	Команда = КомандыПечати.Добавить();
//	Команда.Представление = "Сводная нонемклатура дел";
//	Команда. = ;
//	Команда. = ;
//	Команда. = ;
//	
//КонецПроцедуры 

Функция ПечатьСводнаяНоменклатураДел(МассивОбъектов, ОбъектыПечати = Неопределено, ПараметрыПечати = Неопределено) Экспорт
	// QR-7915900-1 Котляров 2025,07,08	САНФ-035025 
	//перенесено и доработано из внешней обработки, во внешней обработки эти команды закоментированы
	// Создаем табличный документ и устанавливаем имя параметров печати
	ТабДок = Новый ТабличныйДокумент;
	ТабДок.ИмяПараметровПечати = "ЦППК_СводнаяНоменклатураДел";
	
	Макет = ПолучитьМакет("ПФ_MXL_СводнаяНоменклатураДел");
	Подразделение = ПараметрыПечати.Подразделение;
	
	ЗапросРазделы = Новый Запрос;
	ЗапросРазделы.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РазделыНоменклатурыДел.Ссылка КАК Наименование,
	|	РазделыНоменклатурыДел.ПометкаУдаления КАК ПометкаУдаления,
	|	РазделыНоменклатурыДел.Индекс КАК Индекс
	|ИЗ
	|	Справочник.РазделыНоменклатурыДел КАК РазделыНоменклатурыДел
	|ГДЕ
	|	НЕ РазделыНоменклатурыДел.ПометкаУдаления
	|	И РазделыНоменклатурыДел.Год = &Год
	|	И 1=&УсловиеПодразделения
	|	И РазделыНоменклатурыДел.Организация = &Организация
	|
	|УПОРЯДОЧИТЬ ПО
	|	РазделыНоменклатурыДел.ЦППК_РазрядПорядка ИЕРАРХИЯ";
		
	ЗапросРазделы.УстановитьПараметр("Год", ПараметрыПечати.Год);
	ЗапросРазделы.УстановитьПараметр("Организация", ПараметрыПечати.Организация);
	Если ЗначениеЗаполнено(Подразделение) Тогда
		ЗапросРазделы.Текст = СтрЗаменить(ЗапросРазделы.Текст, "И 1=&УсловиеПодразделения", "И РазделыНоменклатурыДел.Подразделение = &Подразделение");
		ЗапросРазделы.УстановитьПараметр("Подразделение", ПараметрыПечати.Подразделение);
	Иначе
		ЗапросРазделы.Текст = СтрЗаменить(ЗапросРазделы.Текст, "И 1=&УсловиеПодразделения", "");
	КонецЕсли;
	ВыборкаРазделы = ЗапросРазделы.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);

	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СправочникНоменклатураДел.Индекс КАК Индекс,
	|	СправочникНоменклатураДел.ПолноеНаименование КАК Наименование,
	|	СправочникНоменклатураДел.Раздел КАК Раздел,
	|	СправочникНоменклатураДел.ОтметкаЭПК КАК ОтметкаЭПК,
	|	СправочникНоменклатураДел.НомераСтатей КАК НомераСтатей,
	|	СправочникНоменклатураДел.СрокХранения КАК СрокХранения,
	|	СправочникНоменклатураДел.Примечание КАК Примечание,
	|	Дела.КоличествоТомов КАК КоличествоТомов,
	|	СправочникНоменклатураДел.Раздел.Подразделение КАК РазделПодразделение
	|ИЗ
	|	Справочник.НоменклатураДел КАК СправочникНоменклатураДел
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ РАЗЛИЧНЫЕ
	|			КОЛИЧЕСТВО(ДелаХраненияДокументов.Ссылка) КАК КоличествоТомов,
	|			ДелаХраненияДокументов.НоменклатураДел КАК НоменклатураДел
	|		ИЗ
	|			Справочник.ДелаХраненияДокументов КАК ДелаХраненияДокументов
	|		ГДЕ
	|			НЕ ДелаХраненияДокументов.ПометкаУдаления
	|		
	|		СГРУППИРОВАТЬ ПО
	|			ДелаХраненияДокументов.НоменклатураДел) КАК Дела
	|		ПО СправочникНоменклатураДел.Ссылка = Дела.НоменклатураДел
	|ГДЕ
	|	НЕ СправочникНоменклатураДел.ПометкаУдаления
	|	И СправочникНоменклатураДел.Год = &Год
	|	И 1=&УсловиеПодразделения
	|	И (СправочникНоменклатураДел.Организация = &Организация
	|			ИЛИ &ИспользоватьУчетПоОрганизациям = ЛОЖЬ
	|			ИЛИ &Организация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка))
	|{ГДЕ
	|	(СправочникНоменклатураДел.Раздел.Подразделение = &Подразделение) КАК УсловиеПодразделения}
	|
	|УПОРЯДОЧИТЬ ПО
	|	СправочникНоменклатураДел.ЦППК_РазрядПорядка ИЕРАРХИЯ";
	
	Если ЗначениеЗаполнено(Подразделение) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И 1=&УсловиеПодразделения", "И СправочникНоменклатураДел.Раздел.Подразделение = &Подразделение");
		Запрос.УстановитьПараметр("Подразделение", ПараметрыПечати.Подразделение);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И 1=&УсловиеПодразделения", "");
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Год", ПараметрыПечати.Год);
	Запрос.УстановитьПараметр("Организация", ПараметрыПечати.Организация);
	Запрос.УстановитьПараметр("ИспользоватьУчетПоОрганизациям", ПолучитьФункциональнуюОпцию("ИспользоватьУчетПоОрганизациям"));
	Результат = Запрос.Выполнить();
	ВыборкаСтроки = Результат.Выбрать();
	
	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьШапка 	 = Макет.ПолучитьОбласть("Шапка");
	ОбластьСтрока 	 = Макет.ПолучитьОбласть("Строка");
	ОбластьРаздел 	 = Макет.ПолучитьОбласть("Раздел");
	ОбластьПодвал    = Макет.ПолучитьОбласть("Подвал");
	ТабДок.Очистить();

	// заголовок
	ДатаПечати = ТекущаяДатаСеанса();
	
	ОбластьЗаголовок.Параметры.Год = Формат(ПараметрыПечати.Год, "ЧГ=");
	ОбластьЗаголовок.Параметры.НаименованиеПредприятия
			= Справочники.Организации.ПредставлениеОрганизацииНаДату(ПараметрыПечати.Организация, НачалоГода(ДатаПечати));
	
	Если ЗначениеЗаполнено(Подразделение) Тогда
		//ОбластьЗаголовок.Параметры.НаименованиеПодразделения = Подразделение.Наименование;
	Иначе 	
		Руководитель = РаботаСОрганизациями.ПолучитьОтветственноеЛицо("Руководитель", ПараметрыПечати.Организация, ДатаПечати);
		//ОбластьЗаголовок.Параметры.Руководитель = Руководитель.ПредставлениеВДокументах;
	КонецЕсли;
	
	ТабДок.Вывести(ОбластьЗаголовок);
	
	// шапка
	ТабДок.Вывести(ОбластьШапка);
	
	// разделы
	Пока ВыборкаРазделы.Следующий() Цикл
		Если ВыборкаРазделы.ПометкаУдаления Тогда 
			Продолжить;
		КонецЕсли;	
		
		ОбластьРаздел.Параметры.Индекс = ВыборкаРазделы.Индекс;
		ОбластьРаздел.Параметры.Наименование = ВыборкаРазделы.Наименование;
		ТабДок.Вывести(ОбластьРаздел);
		
		// строки
		ВыборкаСтроки.Сбросить();
		Пока ВыборкаСтроки.НайтиСледующий(ВыборкаРазделы.Наименование, "Раздел") Цикл
			ОбластьСтрока.Параметры.Заполнить(ВыборкаСтроки);
			
			НомераСтатей = ВыборкаСтроки.НомераСтатей;
			СрокХранения = ВыборкаСтроки.СрокХранения;
			ОтметкаЭПК 	 = ВыборкаСтроки.ОтметкаЭПК;
			
			Если ТипЗнч(СрокХранения) = Тип("Число") Тогда 
				ОбластьСтрока.Параметры.СрокХраненияНомераСтатей = Строка(СрокХранения) + " "
				+ ДелопроизводствоКлиентСервер.ПодписьЛет(СрокХранения) 
				+ ?(ОтметкаЭПК, " ЭПК", "") 
				+ ?(ЗначениеЗаполнено(НомераСтатей), ", " + НомераСтатей, "");
			Иначе
				ОбластьСтрока.Параметры.СрокХраненияНомераСтатей = СрокХранения 
				+ ?(ОтметкаЭПК, " ЭПК", "")
				+ ?(ЗначениеЗаполнено(НомераСтатей), ", " + НомераСтатей, "");
			КонецЕсли;
			
			ТабДок.Вывести(ОбластьСтрока);
		КонецЦикла;	

		// РазделПодчиненный 
		
		ВыборкаРазделПодчиненный = ВыборкаРазделы.Выбрать();
		Пока ВыборкаРазделПодчиненный.Следующий() Цикл
			
			ОбластьРаздел.Параметры.Индекс = ВыборкаРазделПодчиненный.Индекс;
			ОбластьРаздел.Параметры.Наименование = ВыборкаРазделПодчиненный.Наименование;
			ТабДок.Вывести(ОбластьРаздел);
			
			// строки
			ВыборкаСтроки.Сбросить();
			Пока ВыборкаСтроки.НайтиСледующий(ВыборкаРазделПодчиненный.Наименование, "Раздел") Цикл
				ОбластьСтрока.Параметры.Заполнить(ВыборкаСтроки);
				
				НомераСтатей = ВыборкаСтроки.НомераСтатей;
				СрокХранения = ВыборкаСтроки.СрокХранения;
				ОтметкаЭПК 	 = ВыборкаСтроки.ОтметкаЭПК;
				
				Если ТипЗнч(СрокХранения) = Тип("Число") Тогда 
					ОбластьСтрока.Параметры.СрокХраненияНомераСтатей = Строка(СрокХранения) + " "
					+ ДелопроизводствоКлиентСервер.ПодписьЛет(СрокХранения) 
					+ ?(ОтметкаЭПК, " ЭПК", "") 
					+ ?(ЗначениеЗаполнено(НомераСтатей), ", " + НомераСтатей, "");
				Иначе
					ОбластьСтрока.Параметры.СрокХраненияНомераСтатей = СрокХранения 
					+ ?(ОтметкаЭПК, " ЭПК", "")
					+ ?(ЗначениеЗаполнено(НомераСтатей), ", " + НомераСтатей, "");
				КонецЕсли;
				
				ТабДок.Вывести(ОбластьСтрока);
			КонецЦикла;	
			
		КонецЦикла;		
		
	КонецЦикла;
	
	// Подвал	
	Если ЗначениеЗаполнено(Подразделение) Тогда
		РуководительДОУ = СтруктураПредприятия.РуководительПодразделения(ПараметрыПечати.Подразделение);
	Иначе		
		РуководительДОУ = РаботаСОрганизациями.ПолучитьОтветственноеЛицо("РуководительСлужбыДОУ", ПараметрыПечати.Организация, ДатаПечати);
	КонецЕсли;
	
	ОбластьПодвал.Параметры.РуководительДОУ = РуководительДОУ.ПредставлениеВДокументах;
	ДолжностьРуководителяДОУ = РаботаСПользователями.ПолучитьДолжность(РуководительДОУ);
	
	Если Не ЗначениеЗаполнено(ДолжностьРуководителяДОУ) И ЗначениеЗаполнено(Подразделение) Тогда 
		ДолжностьРуководителяДОУ = НСтр("ru = 'Руководитель структурного подразделения'");
	ИначеЕсли Не ЗначениеЗаполнено(ДолжностьРуководителяДОУ) Тогда
		ДолжностьРуководителяДОУ = НСтр("ru = 'Руководитель службы ДОУ'");
	КонецЕсли;
	
	ОбластьПодвал.Параметры.ДолжностьРуководителяДОУ = ДолжностьРуководителяДОУ;
	//ОбластьПодвал.Параметры.Дата = Формат(ТекущаяДата(), "ДЛФ=D");
	
	РуководительАрхива = РаботаСОрганизациями.ПолучитьОтветственноеЛицо("РуководительАрхива", ПараметрыПечати.Организация, ДатаПечати);
	ОбластьПодвал.Параметры.РуководительАрхива = РуководительАрхива.ПредставлениеВДокументах;
	
	ТабДок.Вывести(ОбластьПодвал);
	
	ТабДок.ИмяПараметровПечати = "ПараметрыПечати_НоменклатураДел";
	ТабДок.ОриентацияСтраницы = ОриентацияСтраницы.Портрет;
	ТабДок.АвтоМасштаб = Истина;
	ТабДок.ОтображатьСетку = Ложь;
	ТабДок.Защита = Ложь;
	ТабДок.ТолькоПросмотр = Ложь;
	ТабДок.ОтображатьЗаголовки = Ложь;
	
	Возврат ТабДок;
	
КонецФункции

&После("Печать")
Процедура ЦППК_Печать(МассивОбъектов, ПараметрыПечати, КоллекцияПечатныхФорм, ОбъектыПечати, ПараметрыВывода)
	// QR-7915900-1 Котляров 2025,07,08 САНФ-035025
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "СводнаяНоменклатураДел") Тогда

	// Формируем табличный документ и добавляем его в коллекцию печатных форм
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(
			КоллекцияПечатныхФорм,
			"СводнаяНоменклатураДел",
			"Сводная номенклатура дел",
			ПечатьСводнаяНоменклатураДел(МассивОбъектов, ОбъектыПечати, ПараметрыПечати),
			,
			"Справочник.НоменклатураДел.ПФ_MXL_ИтоговаяЗапись");
	КонецЕсли;
КонецПроцедуры



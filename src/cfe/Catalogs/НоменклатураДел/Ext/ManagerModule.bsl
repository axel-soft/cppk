

Функция ЦППК_ПечатьСводнаяНоменклатураДел(МассивОбъектов, ОбъектыПечати = Неопределено, ПараметрыПечати = Неопределено) Экспорт
	// Инициализация табличного документа
	ТабДок = Новый ТабличныйДокумент;
	ТабДок.ИмяПараметровПечати = "ЦППК_СводнаяНоменклатураДел";
	
	// Получение данных
	Макет = ПолучитьМакет("ПФ_MXL_СводнаяНоменклатураДел");
	Подразделение = ПараметрыПечати.Подразделение;
	
	// Выполнение запросов
	ВыборкаРазделы = ЦППК_ПолучитьРазделыНоменклатуры(ПараметрыПечати);
	ВыборкаСтроки = ЦППК_ПолучитьНоменклатуруДел(ПараметрыПечати);
	
	// Инициализация областей макета
	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьШапка    = Макет.ПолучитьОбласть("Шапка");
	ОбластьСтрока   = Макет.ПолучитьОбласть("Строка");
	ОбластьРаздел   = Макет.ПолучитьОбласть("Раздел");
	ОбластьПодвал   = Макет.ПолучитьОбласть("Подвал");
	ТабДок.Очистить();
	
	// Вывод заголовка
	ЦППК_ВывестиЗаголовок(ТабДок, ОбластьЗаголовок, ПараметрыПечати, Подразделение);
	
	// Вывод шапки
	ТабДок.Вывести(ОбластьШапка);
	
	// Вывод разделов и строк
	ЦППК_ВывестиРазделыИСтроки(ТабДок, ВыборкаРазделы, ВыборкаСтроки, ОбластьРаздел, ОбластьСтрока);
	
	// Вывод подвала
	ЦППК_ВывестиПодвал(ТабДок, ОбластьПодвал, ПараметрыПечати, Подразделение);
	
	// Настройка табличного документа
	ЦППК_НастроитьТабличныйДокумент(ТабДок);
	
	Возврат ТабДок;
КонецФункции

Функция ЦППК_ПолучитьРазделыНоменклатуры(ПараметрыПечати)
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|    РазделыНоменклатурыДел.Ссылка КАК Наименование,
	|    РазделыНоменклатурыДел.ПометкаУдаления КАК ПометкаУдаления,
	|    РазделыНоменклатурыДел.Индекс КАК Индекс
	|ИЗ
	|    Справочник.РазделыНоменклатурыДел КАК РазделыНоменклатурыДел
	|ГДЕ
	|    НЕ РазделыНоменклатурыДел.ПометкаУдаления
	|    И РазделыНоменклатурыДел.Год = &Год
	|    И 1=&УсловиеПодразделения
	|    И РазделыНоменклатурыДел.Организация = &Организация
	|
	|УПОРЯДОЧИТЬ ПО
	|    РазделыНоменклатурыДел.ЦППК_РазрядПорядка ИЕРАРХИЯ";
	
	Запрос.УстановитьПараметр("Год", ПараметрыПечати.Год);
	Запрос.УстановитьПараметр("Организация", ПараметрыПечати.Организация);
	
	Если ЗначениеЗаполнено(ПараметрыПечати.Подразделение) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И 1=&УсловиеПодразделения", 
		"И РазделыНоменклатурыДел.Подразделение = &Подразделение");
		Запрос.УстановитьПараметр("Подразделение", ПараметрыПечати.Подразделение);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И 1=&УсловиеПодразделения", "");
	КонецЕсли;
	
	Возврат Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);
КонецФункции

Функция ЦППК_ПолучитьНоменклатуруДел(ПараметрыПечати)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	КОЛИЧЕСТВО(ДелаХраненияДокументов.Ссылка) КАК КоличествоТомов,
	|	ДелаХраненияДокументов.НоменклатураДел КАК НоменклатураДел
	|ПОМЕСТИТЬ Тома
	|ИЗ
	|	Справочник.ДелаХраненияДокументов КАК ДелаХраненияДокументов
	|ГДЕ
	|	НЕ ДелаХраненияДокументов.ПометкаУдаления
	|
	|СГРУППИРОВАТЬ ПО
	|	ДелаХраненияДокументов.НоменклатураДел
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СправочникНоменклатураДел.Индекс КАК Индекс,
	|	СправочникНоменклатураДел.ПолноеНаименование КАК Наименование,
	|	СправочникНоменклатураДел.Раздел КАК Раздел,
	|	СправочникНоменклатураДел.ОтметкаЭПК КАК ОтметкаЭПК,
	|	СправочникНоменклатураДел.НомераСтатей КАК НомераСтатей,
	|	СправочникНоменклатураДел.СрокХранения КАК СрокХранения,
	|	СправочникНоменклатураДел.Примечание КАК Примечание,
	|	Тома.КоличествоТомов КАК КоличествоТомов,
	|	СправочникНоменклатураДел.Раздел.Подразделение КАК РазделПодразделение
	|ИЗ
	|	Тома КАК Тома
	|		ПРАВОЕ СОЕДИНЕНИЕ Справочник.НоменклатураДел КАК СправочникНоменклатураДел
	|		ПО Тома.НоменклатураДел = СправочникНоменклатураДел.Ссылка
	|ГДЕ
	|	НЕ СправочникНоменклатураДел.ПометкаУдаления
	|	И СправочникНоменклатураДел.Год = &Год
	|	И 1 = &УсловиеПодразделения
	|	И (СправочникНоменклатураДел.Организация = &Организация
	|			ИЛИ &ИспользоватьУчетПоОрганизациям = ЛОЖЬ
	|			ИЛИ &Организация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка))";
	
	Если ЗначениеЗаполнено(ПараметрыПечати.Подразделение) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И 1 = &УсловиеПодразделения", 
		"И СправочникНоменклатураДел.Раздел.Подразделение = &Подразделение");
		Запрос.УстановитьПараметр("Подразделение", ПараметрыПечати.Подразделение);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И 1 = &УсловиеПодразделения", "");
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Год", ПараметрыПечати.Год);
	Запрос.УстановитьПараметр("Организация", ПараметрыПечати.Организация);
	Запрос.УстановитьПараметр("ИспользоватьУчетПоОрганизациям", 
	ПолучитьФункциональнуюОпцию("ИспользоватьУчетПоОрганизациям"));
	
	Возврат Запрос.Выполнить().Выбрать();
КонецФункции

Процедура ЦППК_ВывестиЗаголовок(ТабДок, ОбластьЗаголовок, ПараметрыПечати, Подразделение)
	ДатаПечати = ТекущаяДатаСеанса();
	
	ОбластьЗаголовок.Параметры.Год = Формат(ПараметрыПечати.Год, "ЧГ=");
	ОбластьЗаголовок.Параметры.НаименованиеПредприятия = 
	Справочники.Организации.ПредставлениеОрганизацииНаДату(
	ПараметрыПечати.Организация, НачалоГода(ДатаПечати));
	
	ТабДок.Вывести(ОбластьЗаголовок);
КонецПроцедуры

Процедура ЦППК_ВывестиРазделыИСтроки(ТабДок, ВыборкаРазделы, ВыборкаСтроки, ОбластьРаздел, ОбластьСтрока)
	Пока ВыборкаРазделы.Следующий() Цикл
		Если ВыборкаРазделы.ПометкаУдаления Тогда 
			Продолжить;
		КонецЕсли;    
		
		ОбластьРаздел.Параметры.Индекс = ВыборкаРазделы.Индекс;
		ОбластьРаздел.Параметры.Наименование = ВыборкаРазделы.Наименование;
		ТабДок.Вывести(ОбластьРаздел);
		
		ЦППК_ВывестиСтрокиРаздела(ТабДок, ВыборкаСтроки, ВыборкаРазделы.Наименование, ОбластьСтрока);
		
		// Обработка подчиненных разделов
		ВыборкаРазделПодчиненный = ВыборкаРазделы.Выбрать();
		Пока ВыборкаРазделПодчиненный.Следующий() Цикл
			ОбластьРаздел.Параметры.Индекс = ВыборкаРазделПодчиненный.Индекс;
			ОбластьРаздел.Параметры.Наименование = ВыборкаРазделПодчиненный.Наименование;
			ТабДок.Вывести(ОбластьРаздел);
			
			ЦППК_ВывестиСтрокиРаздела(ТабДок, ВыборкаСтроки, ВыборкаРазделПодчиненный.Наименование, ОбластьСтрока);
		КонецЦикла;        
	КонецЦикла;
КонецПроцедуры

Процедура ЦППК_ВывестиСтрокиРаздела(ТабДок, ВыборкаСтроки, Раздел, ОбластьСтрока)
	ВыборкаСтроки.Сбросить();
	Пока ВыборкаСтроки.НайтиСледующий(Раздел, "Раздел") Цикл
		ОбластьСтрока.Параметры.Заполнить(ВыборкаСтроки);
		
		НомераСтатей = ВыборкаСтроки.НомераСтатей;
		СрокХранения = ВыборкаСтроки.СрокХранения;
		ОтметкаЭПК   = ВыборкаСтроки.ОтметкаЭПК;
		
		ОбластьСтрока.Параметры.СрокХраненияНомераСтатей = 
		ЦППК_ПолучитьТекстСрокаХранения(СрокХранения, ОтметкаЭПК, НомераСтатей);
		
		ТабДок.Вывести(ОбластьСтрока);
	КонецЦикла;
КонецПроцедуры

Функция ЦППК_ПолучитьТекстСрокаХранения(СрокХранения, ОтметкаЭПК, НомераСтатей)
	Если ТипЗнч(СрокХранения) = Тип("Число") Тогда 
		Возврат Строка(СрокХранения) + " " + 
		ДелопроизводствоКлиентСервер.ПодписьЛет(СрокХранения) + 
		?(ОтметкаЭПК, " ЭПК", "") + 
		?(ЗначениеЗаполнено(НомераСтатей), ", " + НомераСтатей, "");
	Иначе
		Возврат СрокХранения + 
		?(ОтметкаЭПК, " ЭПК", "") + 
		?(ЗначениеЗаполнено(НомераСтатей), ", " + НомераСтатей, "");
	КонецЕсли;
КонецФункции

Процедура ЦППК_ВывестиПодвал(ТабДок, ОбластьПодвал, ПараметрыПечати, Подразделение)
	ДатаПечати = ТекущаяДатаСеанса();
	
	Если ЗначениеЗаполнено(Подразделение) Тогда
		РуководительДОУ = СтруктураПредприятия.РуководительПодразделения(Подразделение);
	Иначе        
		РуководительДОУ = РаботаСОрганизациями.ПолучитьОтветственноеЛицо(
		"РуководительСлужбыДОУ", ПараметрыПечати.Организация, ДатаПечати);
	КонецЕсли;
	
	ОбластьПодвал.Параметры.РуководительДОУ = РуководительДОУ.ПредставлениеВДокументах;
	ДолжностьРуководителяДОУ = РаботаСПользователями.ПолучитьДолжность(РуководительДОУ);
	
	Если Не ЗначениеЗаполнено(ДолжностьРуководителяДОУ) Тогда
		ДолжностьРуководителяДОУ = ?(ЗначениеЗаполнено(Подразделение),
		НСтр("ru = 'Руководитель структурного подразделения'"),
		НСтр("ru = 'Руководитель службы ДОУ'"));
	КонецЕсли;
	
	ОбластьПодвал.Параметры.ДолжностьРуководителяДОУ = ДолжностьРуководителяДОУ;
	
	РуководительАрхива = РаботаСОрганизациями.ПолучитьОтветственноеЛицо(
	"РуководительАрхива", ПараметрыПечати.Организация, ДатаПечати);
	ОбластьПодвал.Параметры.РуководительАрхива = РуководительАрхива.ПредставлениеВДокументах;
	
	ТабДок.Вывести(ОбластьПодвал);
КонецПроцедуры

Процедура ЦППК_НастроитьТабличныйДокумент(ТабДок)
	ТабДок.ИмяПараметровПечати = "ПараметрыПечати_НоменклатураДел";
	ТабДок.ОриентацияСтраницы = ОриентацияСтраницы.Портрет;
	ТабДок.АвтоМасштаб = Истина;
	ТабДок.ОтображатьСетку = Ложь;
	ТабДок.Защита = Ложь;
	ТабДок.ТолькоПросмотр = Ложь;
	ТабДок.ОтображатьЗаголовки = Ложь;
КонецПроцедуры

&После("Печать")
Процедура ЦППК_Печать(МассивОбъектов, ПараметрыПечати, КоллекцияПечатныхФорм, ОбъектыПечати, ПараметрыВывода)
	// QR-7915900-1 Котляров 07.07.2025 САНФ-035025
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "СводнаяНоменклатураДел") Тогда
		
		// Формируем табличный документ и добавляем его в коллекцию печатных форм
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(
		КоллекцияПечатныхФорм,
		"СводнаяНоменклатураДел",
		"Сводная номенклатура дел",
		ЦППК_ПечатьСводнаяНоменклатураДел(МассивОбъектов, ОбъектыПечати, ПараметрыПечати),
		,
		"Справочник.НоменклатураДел.ПФ_MXL_ИтоговаяЗапись");
	КонецЕсли;
КонецПроцедуры



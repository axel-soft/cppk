
&НаСервере
&ИзменениеИКонтроль("УстановитьДоступностьИзмененияУчастников")
Процедура ЦППК_УстановитьДоступностьИзмененияУчастников()

#Удаление
	Если ТолькоПросмотр = Истина Тогда
		Возврат;
	КонецЕсли;
#КонецУдаления
#Вставка
	// Оставляем видимость способа подписания только полноправному пользователю.
	Элементы.СпособПодписания.Видимость = Пользователи.ЭтоПолноправныйПользователь();

	Если ТолькоПросмотр = Истина Тогда
		Возврат;
	КонецЕсли;
#КонецВставки

	РазрешениеОбщее = Неопределено;
	НайденныеРазрешения = Разрешения.НайтиСтроки(
	Новый Структура("ИдентификаторЭтапа", 
	ДействияСервер.ПредопределенныйИдентификаторУчастника("Пустой")));
	Если НайденныеРазрешения.Количество() > 0 Тогда
		РазрешениеОбщее = НайденныеРазрешения[0].Разрешение;
	КонецЕсли;

	Если РазрешениеОбщее = Перечисления.ВариантыДоступностиИзмененияДействий.Запрещено
		Или РазрешениеОбщее = Перечисления.ВариантыДоступностиИзмененияДействий.РазрешеноДобавлять Тогда

		Элементы.Автор.Доступность = Ложь;
		Элементы.СпособПодписания.Доступность = Ложь;
		Элементы.ГруппаОписаниеОтложенногоВыполнения.Доступность = Ложь;

	КонецЕсли;

	Если РазрешениеОбщее = Перечисления.ВариантыДоступностиИзмененияДействий.РазрешеноДобавлять Тогда
		МожноТолькоДобавлятьУчастников = Истина;
	КонецЕсли;

	Если РазрешениеОбщее = Перечисления.ВариантыДоступностиИзмененияДействий.Разрешено Тогда
		МожноДобавлятьУчастников = Истина;
	КонецЕсли;

	ЭтапыУчастников = Участники.ПолучитьЭлементы();
	Для Каждого ЭтапУчастников Из ЭтапыУчастников Цикл
		РазрешениеЭтапа = РазрешениеОбщее;
		Если ЭтапУчастников.Идентификатор <> ИдентификаторЭтапаПодписать Тогда
			НайденныеРазрешения = Разрешения.НайтиСтроки(
			Новый Структура("ИдентификаторЭтапа", ЭтапУчастников.Идентификатор));
			Если НайденныеРазрешения.Количество() > 0 Тогда
				РазрешениеЭтапа = НайденныеРазрешения[0].Разрешение;
			КонецЕсли;
		КонецЕсли;

		ЭтапУчастников.Недоступно =
		РазрешениеЭтапа = Перечисления.ВариантыДоступностиИзмененияДействий.Запрещено
		Или РазрешениеЭтапа = Перечисления.ВариантыДоступностиИзмененияДействий.РазрешеноДобавлять
		// Завершенные этапы запрещаем редактировать
		Или (ЭтапУчастников.Состояние = Перечисления.СостоянияВыполненияДействий.Завершено
		И Не ИсполнениеДействияСНовымиУчастниками);
		ЭтапУчастников.РазрешеноДобавлять =
		РазрешениеЭтапа = Перечисления.ВариантыДоступностиИзмененияДействий.РазрешеноДобавлять;
		УчастникиЭтапа = ЭтапУчастников.ПолучитьЭлементы();
		Для Каждого УчастникЭтапа Из УчастникиЭтапа Цикл

			УчастникЭтапа.Недоступно =
			ЭтапУчастников.Недоступно И ЗначениеЗаполнено(УчастникЭтапа.Участник)
			Или УчастникЭтапа.Состояние = Перечисления.СостоянияВыполненияДействий.Завершено;

			УчастникЭтапа.РазрешеноДобавлять = ЭтапУчастников.РазрешеноДобавлять;

			ОбеспечивающиеПодписание = УчастникЭтапа.ПолучитьЭлементы();
			Для Каждого ОбеспечивающийПодписание Из ОбеспечивающиеПодписание Цикл
				ОбеспечивающийПодписание.Недоступно = ЭтапУчастников.Недоступно Или УчастникЭтапа.РазрешеноДобавлять;
			КонецЦикла;

		КонецЦикла;
	КонецЦикла;

КонецПроцедуры

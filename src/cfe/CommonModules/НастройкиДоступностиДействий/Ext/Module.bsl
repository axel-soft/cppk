#Область СлужебныеПроцедурыИФункции

&ИзменениеИКонтроль("РазрешенияСотрудникаПоДействию")
Функция ЦППК_РазрешенияСотрудникаПоДействию(Действие)

	РазрешенияСотрудника = Новый Соответствие;

	Если ДействияСервер.РолиПерекрываютНастройкиДоступностиДействий() Тогда
		РазрешенияСотрудника.Вставить(
		ДействияСервер.ПредопределенныйИдентификаторУчастника("Пустой"),
		Перечисления.ВариантыДоступностиИзмененияДействий.Разрешено);
		Возврат РазрешенияСотрудника;
	КонецЕсли;

	#Вставка
	//++AxelSoft Шарапова 14.10.2024 САНФ-029364
	Если РольДоступна("ЦППК_РазрешитьИзменятьНастройкиОбработкиДокумента") Тогда
        ЦППК_ПроверитьДоступКДокументу(Действие.Предмет);
		РазрешенияСотрудника.Вставить(
		ДействияСервер.ПредопределенныйИдентификаторУчастника("Пустой"),
		Перечисления.ВариантыДоступностиИзмененияДействий.Разрешено);
		Возврат РазрешенияСотрудника;
	КонецЕсли;
	//--AxelSoft Шарапова 14.10.2024 САНФ-029364
	#КонецВставки

	Если ТипЗнч(Действие) = Тип("ДанныеФормыСтруктура") Тогда
		НастройкаДействия = Действие.НастройкаДействия;
	Иначе
		НастройкаДействия = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Действие,
		"НастройкаДействия");
	КонецЕсли;

	Если Не ЗначениеЗаполнено(НастройкаДействия) Тогда
		РазрешенияСотрудника.Вставить(
		ДействияСервер.ПредопределенныйИдентификаторУчастника("Пустой"),
		Перечисления.ВариантыДоступностиИзмененияДействий.Разрешено);
		Возврат РазрешенияСотрудника;
	КонецЕсли;

	МенеджерНастройкиДействия = ОбщегоНазначения.МенеджерОбъектаПоСсылке(НастройкаДействия);
	РазрешенияСотрудника = МенеджерНастройкиДействия.РазрешенияИзмененияУчастников(
	НастройкаДействия);

	Возврат РазрешенияСотрудника;

КонецФункции

Процедура ЦППК_ПроверитьДоступКДокументу(Предмет)

	УстановитьПривилегированныйРежим(Истина);
	
	ТекущиеСотрудники = Сотрудники.ТекущийПользовательИСотрудники();
	ПервыйСотрудник = ТекущиеСотрудники[0];
	
	ОбъектМетаданных = ОбщегоНазначения.ИдентификаторОбъектаМетаданных(ТипЗнч(Предмет));
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ДескрипторыДоступаОбъектов.Ссылка КАК Дескриптор
		|ИЗ
		|	Справочник.ДескрипторыДоступаОбъектов КАК ДескрипторыДоступаОбъектов
		|ГДЕ
		|	ДескрипторыДоступаОбъектов.КонтейнерСотрудников В(&КонтейнерСотрудников)
		|	И ДескрипторыДоступаОбъектов.ИдентификаторОбъектаМетаданных = &ИдентификаторОбъектаМетаданных
		|	И ДескрипторыДоступаОбъектов.Изменение";
	
	Запрос.УстановитьПараметр("ИдентификаторОбъектаМетаданных", ОбъектМетаданных);
	Запрос.УстановитьПараметр("КонтейнерСотрудников", ПервыйСотрудник);
	
	РезультатЗапроса = Запрос.Выполнить();

	Если НЕ РезультатЗапроса.Пустой() Тогда	
		
		Выборка = РезультатЗапроса.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			ИндивидуальныйДескриптор = Выборка.Дескриптор;	
			
		КонецЦикла;	
		
		ДексрипторыОбъекта = РегистрыСведений.ДескрипторыДляОбъектов.ПолучитьДескрипторыОбъекта(Предмет);
		НайденныйДескриптор = ДексрипторыОбъекта.Найти(ИндивидуальныйДескриптор);	
		
		Если НайденныйДескриптор = Неопределено Тогда
			
			НоваяЗапись = РегистрыСведений.ДескрипторыДляОбъектов.СоздатьМенеджерЗаписи();
			НоваяЗапись.Дескриптор = ИндивидуальныйДескриптор;
			НоваяЗапись.Объект = Предмет;
			НоваяЗапись.ОбъектМетаданных = ОбъектМетаданных;
			НоваяЗапись.ТипДескриптора = 1;
						
			НоваяЗапись.Записать();
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти


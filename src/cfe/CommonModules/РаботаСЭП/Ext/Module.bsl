
&ИзменениеИКонтроль("ОбновитьОтметкуЭП")
Процедура ЦППК_ОбновитьОтметкуЭП(Документ, ЭП)

	ИтоговыйФорматPdf = Ложь;
	НастройкиШтампаЭП = РаботаСФайламиВызовСервера.ПолучитьНастройкиШтампаЭП(Документ);
	Если НастройкиШтампаЭП.ИтоговыйФорматФайлаСоШтампомЭП = Перечисления.ИтоговыйФорматФайлаСоШтампомЭП.PDFA Тогда
		ИтоговыйФорматPdf = Истина;
	КонецЕсли;	

	ОписаниеЭП = ОписаниеЭПДляОтметки(ЭП);
#Удаление
	ПутьКОтметкеЭП = СоздатьОтметкуЭП(ОписаниеЭП, ИтоговыйФорматPdf);
#КонецУдаления
#Вставка
	ПутьКОтметкеЭП = ЦППК_СгенерироватьОтметкуЭП(ОписаниеЭП, ИтоговыйФорматPdf, Документ);
#КонецВставки
	ЗаписатьОтметкуЭП(Документ, ЭП.ИдентификаторПодписи, ПутьКОтметкеЭП);
	УдалитьФайлы(ПутьКОтметкеЭП);

КонецПроцедуры

&ИзменениеИКонтроль("ОписаниеЭПДляОтметки")
Функция ЦППК_ОписаниеЭПДляОтметки(ЭП)

	ОписаниеЭП = НовоеОписаниеОтметкиЭП();

	Если ЭП = Неопределено Тогда
		Возврат ОписаниеЭП;
	КонецЕсли;

	Если ТипЗнч(ЭП.Сертификат) = Тип("ХранилищеЗначения") Тогда
		ДанныеСертификата = ЭП.Сертификат.Получить();
	Иначе
		ДанныеСертификата = ЭП.Сертификат;
	КонецЕсли;

	Если Не ЗначениеЗаполнено(ДанныеСертификата) Тогда
		Возврат ОписаниеЭП;
	КонецЕсли;

	Сертификат = Новый СертификатКриптографии(ДанныеСертификата);

	ОписаниеЭП.Номер = СтрЗаменить(Сертификат.СерийныйНомер, " ", "");
	ОписаниеЭП.Владелец = ЭП.КомуВыданСертификат;
#Удаление
	ОписаниеЭП.Владелец = СтрЗаменить(ОписаниеЭП.Владелец, """", " ");
#КонецУдаления
	ОписаниеЭП.ДатаНачала = Сертификат.ДатаНачала;
	ОписаниеЭП.ДатаОкончания = Сертификат.ДатаОкончания;

	ОписаниеЭП.ДанныеДоверенности = ОписаниеДоверенностиЭПДляОтметки(ЭП.ИдентификаторПодписи);

	Возврат ОписаниеЭП;

КонецФункции

#Область СлужебныеПроцедурыИФункции

Функция ЦППК_ПолучитьВладельцаЭП_Сокращенно(ВладелецПечати)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	| 	СертификатыКлючейЭлектроннойПодписиИШифрования.Фамилия КАК Фамилия,
	| 	СертификатыКлючейЭлектроннойПодписиИШифрования.Имя КАК Имя,
	| 	СертификатыКлючейЭлектроннойПодписиИШифрования.Отчество КАК Отчество,
	| 	СертификатыКлючейЭлектроннойПодписиИШифрования.Организация КАК Организация
	| ИЗ
	| 	РегистрСведений.ЭлектронныеПодписи КАК ЭлектронныеПодписи
	| 		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СертификатыКлючейЭлектроннойПодписиИШифрования КАК СертификатыКлючейЭлектроннойПодписиИШифрования
	| 		ПО ЭлектронныеПодписи.Отпечаток = СертификатыКлючейЭлектроннойПодписиИШифрования.Отпечаток
	| ГДЕ
	| 	ЭлектронныеПодписи.КомуВыданСертификат ПОДОБНО &КомуВыданСертификат";  
	Запрос.УстановитьПараметр("КомуВыданСертификат", ВладелецПечати);
	
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		ОбщегоНазначения.СообщитьПользователю("Не удалось обнаружить сокращенное наименование владельца печати");
		Возврат Неопределено;
	КонецЕсли;
	Выборка = РезультатЗапроса.Выбрать();
	Фамилия = "";
	Имя = "";
	Отчество = "";
	Организация = "";
	
	Если Выборка.Следующий() Тогда
		Фамилия = Выборка.Фамилия;
		Имя = Выборка.Имя;
		Отчество = Выборка.Отчество;
		Организация = Выборка.Организация;
	КонецЕсли;
	
	МассивБукв = Новый Массив;
	ДлинаОрганизации = СтрДлина(Организация);
	ОрганизацияСДвумяКавычками = "";
	
	Для Шаг = 1 По ДлинаОрганизации Цикл
		ПервыйСимвол = Сред(Организация,Шаг,1);
		Если ПервыйСимвол = """" Тогда
			ОрганизацияСДвумяКавычками = ОрганизацияСДвумяКавычками + """";
		КонецЕсли;
		ОрганизацияСДвумяКавычками = ОрганизацияСДвумяКавычками + ПервыйСимвол;
	КонецЦикла;

	Возврат СтрШаблон("%1 %2 %3", Фамилия, Имя, Отчество);
	
КонецФункции

Функция ЦППК_СгенерироватьОтметкуЭП(ОписаниеЭП, ИтоговыйФорматPdf,Документ)
	
	ПутьКОтметкеЭП = РаботаСЭППереопределяемый.СоздатьОтметкуЭП(ОписаниеЭП);
	Если ЗначениеЗаполнено(ПутьКОтметкеЭП) Тогда
		Возврат ПутьКОтметкеЭП;
	КонецЕсли;
	
	Если ОписаниеЭП.ДанныеДоверенности.ПодписьПоДоверенности = Истина Тогда
		ПутьКОтметкеЭП = РаботаСКартинками.СформироватьШтампЭПСДоверенностью(ОписаниеЭП,, ИтоговыйФорматPdf);
	Иначе
		ПутьКОтметкеЭП = ЦППК_СформироватьШтампЭП(ОписаниеЭП,, ИтоговыйФорматPdf, Документ);
	КонецЕсли;
	
	Возврат ПутьКОтметкеЭП;

КонецФункции

Функция ЦППК_СформироватьШтампЭП(ОписаниеЭП, Формат, ИтоговыйФорматPdf, Документ)
		ФайлыКУдалению = Новый Массив;

	Если ИтоговыйФорматPdf = Ложь Тогда	
		МакетСертификат = ПолучитьОбщийМакет("ЦППК_ШаблонОтметкиЭПИсп");
	Иначе
		МакетСертификат = ПолучитьОбщийМакет("ЦППК_ШаблонОтметкиЭПНепрозрачныйИсп");
	КонецЕсли;		
	
	ПутьФайлаШаблона = ПолучитьИмяВременногоФайла(Формат);
	МакетСертификат.Записать(ПутьФайлаШаблона);
	ФайлыКУдалению.Добавить(ПутьФайлаШаблона);
	
	ПараметрыDraw = Новый Массив;
	
	//ПараметрыDraw.Добавить(
	//	СтрШаблон(
	//		"text %1, %2 '%3'",
	//		780, //было 805      //ВЕРХ  100 ВЕЗДЕ
	//		92, //было 95 - высота // прибавил 2(нужно отнять от 103 вероятно 2 или 3) 98  сделать
	//		ОписаниеЭП.Номер));
	//
	//ПараметрыDraw.Добавить(
	//	СтрШаблон(
	//		"text %1, %2 '%3'",
	//		792, //было 805
	//		135, //было 137 //  убавил 2 
	//		СтрШаблон(
	//			НСтр("ru = 'с %1 по %2'"),
	//			Формат(ОписаниеЭП.ДатаНачала, "ДФ=dd.MM.yyyy"),
	//			Формат(ОписаниеЭП.ДатаОкончания, "ДФ=dd.MM.yyyy"))));
	////Axel_Перов +++(		
	ПараметрыDraw.Добавить(
		СтрШаблон(
			"text %1, %2 '%3'",
			260,
			133,
			ОписаниеЭП.Номер));
	
	ПараметрыDraw.Добавить(
		СтрШаблон(
			"text %1, %2 '%3'",
			260,
			232,
			СтрШаблон(
				НСтр("ru = 'с %1 по %2'"),
				Формат(ОписаниеЭП.ДатаНачала, "ДФ=dd.MM.yyyy"),
				Формат(ОписаниеЭП.ДатаОкончания, "ДФ=dd.MM.yyyy"))));
	
	РегистрационныйНомер = "";
	
	Если Документ.РегистрационныйНомер <> Неопределено И ЗначениеЗаполнено(Документ.РегистрационныйНомер) И ЗначениеЗаполнено(Документ.ДатаРегистрации) Тогда
		
		НовыйРегНомер = "";
		СтарыйРегНомер = Документ.РегистрационныйНомер; 
        Для Счетчик = 1 по СтрДлина(СтарыйРегНомер) цикл
			
		  Буква = Сред(СтарыйРегНомер,Счетчик,1);
		  НовыйРегНомер = НовыйРегНомер + Буква;
		  Если Буква = "№" Тогда
			  НовыйРегНомер = НовыйРегНомер + " ";
		  КонецЕсли;
		  
        КонецЦикла;
		
		РегистрационныйНомер = СтрШаблон("%1 от %2 ",НовыйРегНомер,Формат(Документ.ДатаРегистрации,"ДФ=dd.MM.yyyy; ДЛФ="));  

	КонецЕсли;  
	
	//ПараметрыDraw.Добавить(
	//	СтрШаблон(
	//		"text %1, %2 '%3'",
	//		683, //было 705  //НЕ ТРОГАТЬ!!!
	//		158, //было 190 - высота Высоту прибавил на 100, было 100
	//		РегистрационныйНомер));
	
	//ПараметрыDraw.Добавить(
	//	СтрШаблон(
	//		"text %1, %2 '%3'",
	//		12,
	//		285,  //285
	//		РегистрационныйНомер));
			
	ВладелецСокращенно = ЦППК_ПолучитьВладельцаЭП_Сокращенно(ОписаниеЭП.Владелец);		
	
	ПараметрыСоздания = Новый Массив;
	
	ПараметрыСоздания.Добавить(
		СтрШаблон("convert %1", ПутьФайлаШаблона));
	
	ПараметрыСоздания.Добавить(
		СтрШаблон(" -pointsize 36 -fill black -draw ""%1""", 
			СтрСоединить(ПараметрыDraw, " ")));
	
	ПараметрыСоздания.Добавить(
		СтрШаблон(
			"-background none -fill black -stroke None -pointsize 36 -size 940x90 -gravity NorthWest caption:""%1"" -geometry +%2+%3 -composite",
			ВладелецСокращенно,
			260,
			150)); // 260 150 - координаты (лево верх)
			
	ПараметрыСоздания.Добавить(
		СтрШаблон(
			"-pointsize 42 -fill black -draw ""%1""",
			СтрШаблон(
				"text %1, %2 '%3'",
				12,
				250,
				РегистрационныйНомер)));			
	
	//ПараметрыСоздания.Добавить(
	//	СтрШаблон("convert %1", ПутьФайлаШаблона));
	//
	//ПараметрыСоздания.Добавить(
	//	СтрШаблон(" -pointsize 14 -fill ""#000000"" -draw ""%1""",       // было #0A64DC         
	//		СтрСоединить(ПараметрыDraw, " ")));
	//
	//ПараметрыСоздания.Добавить(
	//	СтрШаблон(
	//		"-background none  -fill ""#000000""  -stroke None -pointsize 14 -interline-spacing 0 -size 400x80 -gravity NorthWest caption:""%1"" -geometry +%2+%3 -composite",   // было #0A64DC

	//		//ОписаниеЭП.Владелец,
	//		ВладелецСокращенно,
	//		760,//805 - было
	//		99)); //99 - было	220 почти норм 225 попробовать если не так
	ПутьНовогоФайла = ПолучитьИмяВременногоФайла("PNG");
	
	ПараметрыСоздания.Добавить(ПутьНовогоФайла);
	
	ПараметрыImageMagick = СтрСоединить(ПараметрыСоздания, " ");
	
	РаботаСКартинками.ЗапуститьImageMagick(ПараметрыImageMagick, ФайлыКУдалению);
	
	Возврат ПутьНовогоФайла;
	
КонецФункции  

#КонецОбласти
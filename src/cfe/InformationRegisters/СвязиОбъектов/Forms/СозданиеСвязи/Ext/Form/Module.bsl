
&НаКлиенте
&ИзменениеИКонтроль("ВыбратьПредметКлиент")
Процедура ЦППК_ВыбратьПредметКлиент()

	ТекущиеДанные = Элементы.ДеревоВариантов.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено 
		ИЛИ ТекущиеДанные.ЭтоЗаголовок Тогда
		Возврат;
	КонецЕсли;

	Если ТипЗнч(ТекущиеДанные.КомандаСсылка) = Тип("Строка") 
		И ТекущиеДанные.КомандаСсылка = ВнешнийРесурс Тогда
		ОписаниеОповещения = Новый ОписаниеОповещения(
		"ДобавлениеВнешнегоРесурсаЗавершение",
		ЭтотОбъект);
		ОткрытьФорму("РегистрСведений.СвязиОбъектов.Форма.ФормаВнешнегоРесурса",,
		ЭтаФорма,,,,
		ОписаниеОповещения,
		РежимОткрытияОкнаФормы.БлокироватьВесьИнтерфейс);

	ИначеЕсли ТипЗнч(ТекущиеДанные.КомандаСсылка) = Тип("Строка") Тогда
		ИмяФормыВыбора = ТекущиеДанные.КомандаСсылка + ".ФормаВыбора";

		Если ТекущиеДанные.КомандаСсылка = "Справочник.Файлы" Тогда
			ИмяФормыВыбора = "Справочник.Файлы.Форма.ФормаВыбораФайлаВПапках";		
		КонецЕсли;
		
		ПараметрыФормы = Новый Структура;
#Вставка
		ЯвляетсяВходящейКорреспонденцией = ОбщегоНазначенияДокументооборотВызовСервера.ЗначениеРеквизитаОбъекта(Документ, "ВидДокумента.ЯвляетсяВходящейКорреспонденцией");
		Если ЯвляетсяВходящейКорреспонденцией Тогда
			ПараметрыФормы.Вставить("ЯвляетсяИсходящейКорреспонденцией", Истина);
		КонецЕсли;
#КонецВставки
		ОткрытьФорму(ИмяФормыВыбора, ПараметрыФормы, ЭтаФорма);

	Иначе
		СвязанныйДокумент = ТекущиеДанные.КомандаСсылка;

		ТекстОшибки = "";
		ПерейтиКСозданиюСвязи();

		Если ЗначениеЗаполнено(ТекстОшибки) Тогда 
			ПоказатьПредупреждение(, ТекстОшибки);
		КонецЕсли;

	КонецЕсли;

КонецПроцедуры

&НаКлиенте
&ИзменениеИКонтроль("Готово")
Процедура ЦППК_Готово(Команда)

	Если Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаВыборДокумента Тогда 	
		ТекущиеДанные = Элементы.ДеревоВариантов.ТекущиеДанные;
		ОчиститьСообщения();

		Если ТекущиеДанные = Неопределено 
			ИЛИ ТекущиеДанные.ЭтоЗаголовок Тогда
			ПоказатьПредупреждение(, НСтр("ru = 'Не выбран связанный документ'"));
			Возврат;
		КонецЕсли;

		Если ТипЗнч(ТекущиеДанные.КомандаСсылка) = Тип("Строка") 
			И ТекущиеДанные.КомандаСсылка = ВнешнийРесурс Тогда
			ОписаниеОповещения = Новый ОписаниеОповещения(
			"ДобавлениеВнешнегоРесурсаЗавершение",
			ЭтотОбъект);
			ОткрытьФорму("РегистрСведений.СвязиОбъектов.Форма.ФормаВнешнегоРесурса",,
			ЭтаФорма,,,,
			ОписаниеОповещения,
			РежимОткрытияОкнаФормы.БлокироватьВесьИнтерфейс);

		ИначеЕсли ТипЗнч(ТекущиеДанные.КомандаСсылка) = Тип("Строка") Тогда
			ИмяФормыВыбора = ТекущиеДанные.КомандаСсылка + ".ФормаВыбора";
			Если ТекущиеДанные.КомандаСсылка = "Справочник.Файлы" Тогда
				ИмяФормыВыбора = "Справочник.Файлы.Форма.ФормаВыбораФайлаВПапках";
			КонецЕсли;
			ПараметрыФормы = Новый Структура;
#Вставка
			ЯвляетсяВходящейКорреспонденцией = ОбщегоНазначенияДокументооборотВызовСервера.ЗначениеРеквизитаОбъекта(Документ, "ВидДокумента.ЯвляетсяВходящейКорреспонденцией");
            Если ЯвляетсяВходящейКорреспонденцией Тогда
				ПараметрыФормы.Вставить("ЯвляетсяИсходящейКорреспонденцией", Истина);
			КонецЕсли;
#КонецВставки
			ОткрытьФорму(ИмяФормыВыбора, ПараметрыФормы, ЭтаФорма);

		Иначе
			СвязанныйДокумент = ТекущиеДанные.КомандаСсылка;
			ТекстОшибки = "";
			ПерейтиКСозданиюСвязи();

			Если ЗначениеЗаполнено(ТекстОшибки) Тогда 
				ПоказатьПредупреждение(, ТекстОшибки);
			КонецЕсли;

		КонецЕсли;

	Иначе 
		ТекущиеДанные = Элементы.ТипыСвязейТаблица.ТекущиеДанные;

		Если ТекущиеДанные = Неопределено 
			Или Не ЗначениеЗаполнено(Документ)
			Или Не ЗначениеЗаполнено(СвязанныйДокумент)Тогда
			Возврат;
		КонецЕсли;

		ТипСвязи = ТекущиеДанные.ТипСвязи;
		СоздатьСвязь(ТипСвязи);

		// Оповещение об изменении связей документа
		ТипыСвязейМассив = Новый Массив;
		ТипыСвязейМассив.Добавить(ТипСвязи);

		ПараметрСобытия = Новый Структура;
		ПараметрСобытия.Вставить("Документ", Документ);
		ПараметрСобытия.Вставить("ТипыСвязей", ТипыСвязейМассив);
		ПараметрСобытия.Вставить("СвязанныйОбъект", СвязанныйДокумент);
		Оповестить("ИзмененыСвязиДокумента", ПараметрСобытия, ЭтаФорма);

		// Оповещение об изменении реквизитов документа
		Если РеквизитыВладельцаИзменены Тогда 
			Оповестить("ИзмененыРеквизитыПриИзмененииСвязи", Документ, ЭтаФорма);
		КонецЕсли;	

		Закрыть();

	КонецЕсли;	

КонецПроцедуры


&ИзменениеИКонтроль("ПечатьОписи")
Функция ЦППК_ПечатьОписи(МассивОбъектов, ОбъектыПечати) 
	
	// Создаем табличный документ и устанавливаем имя параметров печати
	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.ИмяПараметровПечати = "ПараметрыПечати_ОписьПередачиДелВАрхив";
	ТабличныйДокумент.АвтоМасштаб = Истина;
	
	// Получаем запросом необходимые данные
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПередачаДелВАрхив.Ссылка КАК Ссылка,
	|	ПередачаДелВАрхив.Организация КАК Организация,
	|	ПередачаДелВАрхив.Дата КАК Дата,
	|	ПередачаДелВАрхив.Номер КАК Номер,
	|	ПередачаДелВАрхив.ФормаДокументов,
	|	ПередачаДелВАрхив.Подразделение,
	|	ПередачаДелВАрхив.ДатаПередачи,
	|	ПередачаДелВАрхив.ДатаПриемки,
	|	ПередачаДелВАрхив.Передал,
	|	ПередачаДелВАрхив.Создал,
	|	ПередачаДелВАрхив.Принял
	|ИЗ
	|	Документ.ПередачаДелВАрхив КАК ПередачаДелВАрхив
	|ГДЕ
	|	ПередачаДелВАрхив.Ссылка В (&МассивОбъектов)";
	Запрос.УстановитьПараметр("МассивОбъектов", МассивОбъектов);
	ВыборкаСсылка = Запрос.Выполнить().Выбрать();
	
	Запрос = Новый Запрос();
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	НоменклатураСпр.Индекс КАК Индекс,
#Удаление
	|	НоменклатураСпр.Раздел КАК Раздел,
	|	НоменклатураСпр.СрокХранения КАК СрокХранения,
	|	НоменклатураСпр.ОтметкаЭПК КАК ОтметкаЭПК,
#КонецУдаления
#Вставка
	|	ВЫБОР
	|		КОГДА НоменклатураДел.Раздел.Индекс ЕСТЬ NULL
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.РазделыНоменклатурыДел.ПустаяСсылка)
	|		ИНАЧЕ НоменклатураДел.Раздел
	|	КОНЕЦ КАК Раздел,
    |	ЕСТЬNULL(НоменклатураДел.СрокХранения, """") КАК СрокХранения,
    |	ЕСТЬNULL(НоменклатураДел.ОтметкаЭПК, Ложь) КАК ОтметкаЭПК,
#КонецВставки
	|	НоменклатураСпр.КатегорияДела КАК КатегорияДела,
	|	ДелаСпр.Комментарий КАК Примечание,
	|	ДелаСпр.ДатаНачала КАК ДатаНачала,
	|	ДелаСпр.ДатаОкончания КАК ДатаОкончания,
	|	ДелаСпр.КоличествоЛистов КАК КоличествоЛистов,
	|	ТабличнаяЧасть.Ссылка КАК Ссылка,
	|	ДелаСпр.Ссылка КАК Дело,
	|	ДелаСпр.ПолноеНаименование КАК Наименование
	|ИЗ
	|	Документ.ПередачаДелВАрхив.ДелаХраненияДокументов КАК ТабличнаяЧасть
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ДелаХраненияДокументов КАК ДелаСпр
	|		ПО ТабличнаяЧасть.ДелоХраненияДокументов = ДелаСпр.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.НоменклатураДел КАК НоменклатураСпр
	|		ПО ДелаСпр.НоменклатураДел = НоменклатураСпр.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.РазделыНоменклатурыДел КАК РазделыСпр
	|		ПО НоменклатураСпр.Раздел = РазделыСпр.Ссылка
	|ГДЕ
	|	ТабличнаяЧасть.Ссылка В (&МассивОбъектов)
	|	И ТабличнаяЧасть.ДелоХраненияДокументов <> ЗНАЧЕНИЕ(Справочник.ДелаХраненияДокументов.ПустаяСсылка)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Ссылка,
	|	Индекс,
	|	Раздел
	|ИТОГИ
	|ПО
	|	Ссылка,
	|	Раздел ИЕРАРХИЯ";
	Запрос.УстановитьПараметр("МассивОбъектов", МассивОбъектов);
	ВыборкаДетали = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Макет = УправлениеПечатью.МакетПечатнойФормы("Документ.ПередачаДелВАрхив.ПФ_MXL_Опись");
	ОбластьОрганизация = Макет.ПолучитьОбласть("Организация");
	ОбластьПодразделение = Макет.ПолучитьОбласть("Подразделение");
	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьШапка 	 = Макет.ПолучитьОбласть("Шапка");
	ОбластьСтрока 	 = Макет.ПолучитьОбласть("Строка");
	ОбластьРаздел 	 = Макет.ПолучитьОбласть("Раздел");
	ОбластьПодвал 	 = Макет.ПолучитьОбласть("Подвал");
	ОбластьПодвалПринял 	 = Макет.ПолучитьОбласть("ПодвалПринял");
	ОбластьПодвалПередал 	 = Макет.ПолучитьОбласть("ПодвалПередал");
	
	ПервыйДокумент = Истина;
	Пока ВыборкаСсылка.Следующий() Цикл
		
		Если Не ПервыйДокумент Тогда
			ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
		КонецЕсли;
		ПервыйДокумент = Ложь;
		
		// Запомним номер строки с которой начали выводить текущий документ
		НомерСтрокиНачало = ТабличныйДокумент.ВысотаТаблицы + 1;
		
		// Организация и подразделение
		ОбластьОрганизация.Параметры.НаименованиеПредприятия = Справочники.Организации.ПредставлениеОрганизацииНаДату(
			ВыборкаСсылка.Организация, ВыборкаСсылка.Дата);
		ТабличныйДокумент.Вывести(ОбластьОрганизация);
		
		Если ЗначениеЗаполнено(ВыборкаСсылка.Подразделение) Тогда
			ОбластьПодразделение.Параметры.НаименованиеПодразделения = ВыборкаСсылка.Подразделение;
			ТабличныйДокумент.Вывести(ОбластьПодразделение);
		КонецЕсли;
		
		// заголовок
		ОбластьЗаголовок.Параметры.НомерДок = ВыборкаСсылка.Номер;
		ОбластьЗаголовок.Параметры.ОтчетныйГод = Формат(Год(ТекущаяДатаСеанса()), "ЧГ=0");
		
		ТабличныйДокумент.Вывести(ОбластьЗаголовок);
		
		// шапка
		ТабличныйДокумент.Вывести(ОбластьШапка);
		Номер = 0;
		
		// разделы
		Если ВыборкаДетали.НайтиСледующий(ВыборкаСсылка.Ссылка, "Ссылка") Тогда
			
			ВыборкаРазделы = ВыборкаДетали.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаРазделы.Следующий() Цикл
				
				СвойстваРаздела = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ВыборкаРазделы.Раздел, "Индекс, Наименование");
				
				ОбластьРаздел.Параметры.Индекс = СвойстваРаздела.Индекс;
				ОбластьРаздел.Параметры.Наименование = СвойстваРаздела.Наименование;
				ТабличныйДокумент.Вывести(ОбластьРаздел);
				
				ВыборкаСтроки = ВыборкаРазделы.Выбрать();
				Пока ВыборкаСтроки.Следующий() Цикл
					Номер = Номер + 1;
					
					ОбластьСтрока.Параметры.Заполнить(ВыборкаСтроки);
					ОбластьСтрока.Параметры.Номер = Номер;
					ОбластьСтрока.Параметры.КрайниеДаты = 
						Формат(ВыборкаСтроки.ДатаНачала, "ДЛФ=D") + " - " +
							Формат(ВыборкаСтроки.ДатаОкончания, "ДЛФ=D");
					
					СрокХранения = ВыборкаСтроки.СрокХранения;
					ОтметкаЭПК = ВыборкаСтроки.ОтметкаЭПК;
					Если ВыборкаСтроки.КатегорияДела = Перечисления.КатегорииДел.Постоянное Тогда
						ОбластьСтрока.Параметры.СрокХранения = "";
					ИначеЕсли ТипЗнч(СрокХранения) = Тип("Число") Тогда 
						ОбластьСтрока.Параметры.СрокХранения =
							Строка(СрокХранения) + " " + ДелопроизводствоКлиентСервер.ПодписьЛет(СрокХранения) +
								?(ОтметкаЭПК, " ЭПК", "");
					Иначе
						ОбластьСтрока.Параметры.СрокХранения = Строка(СрокХранения) + ?(ОтметкаЭПК, " ЭПК", "");
					КонецЕсли;
					ТабличныйДокумент.Вывести(ОбластьСтрока);
				КонецЦикла;
			КонецЦикла;
			
		КонецЕсли;
		
		// подвал
		КоличествоДелСтрокой = СокрЛП(НРег(ЧислоПрописью(Номер, , ",,,с,,,,,0")));
		ОбластьПодвал.Параметры.КоличествоДел = 
			Формат(Номер, "ЧГ=") + " (" + КоличествоДелСтрокой + ")"
			+ "" + СтрЗаменить(СокрЛП(НРег(ЧислоПрописью(Номер, , "дело,дела,дел,с,,,,,0"))), КоличествоДелСтрокой, "");
		ОбластьПодвал.Параметры.НачальныйНомер = 1;
		ОбластьПодвал.Параметры.КонечныйНомер = Номер;
		ОбластьПодвал.Параметры.ДатаДок = Формат(ВыборкаСсылка.Дата, "ДЛФ=D");
		
		РуководительДОУ = Справочники.Организации.ОтветственноеЛицо(
			"РуководительСлужбыДОУ", ВыборкаСсылка.Организация, ВыборкаСсылка.Дата); 
		ОтветственныйЗаДокумент = Сотрудники.ЗаменитьПользователяСотрудником(
			Пользователи.ТекущийПользователь());
		РуководительАрхива = Справочники.Организации.ОтветственноеЛицо(
				"РуководительАрхива", ВыборкаСсылка.Организация, ВыборкаСсылка.Дата);
		Передал = ВыборкаСсылка.Передал;
		Принял = ВыборкаСсылка.Принял;
		МассивДляПолученияФИО = Новый Массив;
		МассивДляПолученияФИО.Добавить(ОтветственныйЗаДокумент);
		МассивДляПолученияФИО.Добавить(РуководительАрхива);
		МассивДляПолученияФИО.Добавить(РуководительДОУ);
		МассивДляПолученияФИО.Добавить(Передал);
		Если ТипЗнч(Принял) = Тип("СправочникСсылка.Сотрудники") Тогда
			МассивДляПолученияФИО.Добавить(Принял);
		КонецЕсли;
		
		ФИОСотрудниковНаДату = 
			Сотрудники.ПредставленияВДокументахСотрудниковНаДату(МассивДляПолученияФИО, ВыборкаСсылка.Дата);
		
		Если ЗначениеЗаполнено(РуководительДОУ) Тогда
			ОбластьПодвал.Параметры.РуководительДОУ = ФИОСотрудниковНаДату[РуководительДОУ];
		Иначе
			ОбластьПодвал.Параметры.РуководительДОУ = НСтр("ru = '<ФИО руководителя ДОУ>'");
		КонецЕсли;
		
		ДолжностьРуководителяДОУ = Сотрудники.ДолжностьСотрудника(РуководительДОУ);
		ОбластьПодвал.Параметры.ДолжностьРуководителяДОУ =
			?(ЗначениеЗаполнено(ДолжностьРуководителяДОУ), ДолжностьРуководителяДОУ, НСтр("ru = '<Должность руководителя ДОУ>'"));
		
		Если ЗначениеЗаполнено(РуководительДОУ) Тогда
			ОбластьПодвал.Параметры.Составитель = ФИОСотрудниковНаДату[ОтветственныйЗаДокумент];
		Иначе
			ОбластьПодвал.Параметры.Составитель = НСтр("ru = '<ФИО руководителя ДОУ>'");
		КонецЕсли;
		
		ДолжностьСоставителя = Сотрудники.ДолжностьСотрудника(ОтветственныйЗаДокумент);
		ОбластьПодвал.Параметры.ДолжностьСоставителя = 
			?(ЗначениеЗаполнено(ДолжностьСоставителя), ДолжностьСоставителя, НСтр("ru = '<Должность составителя>'"));
		
		Если ЗначениеЗаполнено(РуководительАрхива) Тогда
			ОбластьПодвал.Параметры.РуководительАрхива = ФИОСотрудниковНаДату[РуководительАрхива];
		Иначе
			ОбластьПодвал.Параметры.РуководительАрхива = НСтр("ru = '<ФИО руководителя архива>'");
		КонецЕсли;
		
		ДолжностьРуководителяАрхива = Сотрудники.ДолжностьСотрудника(РуководительАрхива);
		ОбластьПодвал.Параметры.ДолжностьРуководителяАрхива = 
			?(ЗначениеЗаполнено(ДолжностьРуководителяАрхива), ДолжностьРуководителяАрхива, НСтр("ru = '<Должность руководителя архива>'"));
			
		ТабличныйДокумент.Вывести(ОбластьПодвал);
		КоличествоЕдиницСтрокой = Формат(Номер, "ЧГ=") + " (" + СокрЛП(НРег(ЧислоПрописью(Номер, , ",,,ж,,,,,0"))) + ")";
		
		Если ЗначениеЗаполнено(РуководительАрхива) Тогда
			ОбластьПодвалПередал.Параметры.Передал = ФИОСотрудниковНаДату[Передал];
		Иначе
			ОбластьПодвалПередал.Параметры.Передал = НСтр("ru = '<ФИО работника подразделения>'");
		КонецЕсли;
		
		ДолжностьПередал = Сотрудники.ДолжностьСотрудника(Передал);
		ОбластьПодвалПередал.Параметры.ДолжностьПередал = 
			?(ЗначениеЗаполнено(ДолжностьПередал), ДолжностьПередал, НСтр("ru = '<Должность работника подразделения>'"));
		ОбластьПодвалПередал.Параметры.ДатаПередачи = 
			?(ЗначениеЗаполнено(ВыборкаСсылка.ДатаПередачи), Формат(ВыборкаСсылка.ДатаПередачи, "ДЛФ=D"),
				НСтр("ru = '<Дата передачи>'"));
		ОбластьПодвалПередал.Параметры.КоличествоДел = КоличествоЕдиницСтрокой;
		ТабличныйДокумент.Вывести(ОбластьПодвалПередал);
		
		Если ТипЗнч(Принял) = Тип("Строка") Тогда
			ОбластьПодвалПринял.Параметры.Принял =
				?(ЗначениеЗаполнено(Принял), СокрЛП(Принял), НСтр("ru = '<ФИО работника архива>'"));
			ОбластьПодвалПринял.Параметры.ДолжностьПринял = НСтр("ru = '<Должность работника архива>'");
		Иначе 
			
			Если ЗначениеЗаполнено(РуководительАрхива) Тогда
				ОбластьПодвалПринял.Параметры.Принял = ФИОСотрудниковНаДату[Принял];
			Иначе
				ОбластьПодвалПринял.Параметры.Принял = НСтр("ru = '<ФИО работника архива>'");
			КонецЕсли;
			
			ДолжностьПринял = Сотрудники.ДолжностьСотрудника(Принял);
			ОбластьПодвалПринял.Параметры.ДолжностьПринял = 
				?(ЗначениеЗаполнено(ДолжностьПринял), ДолжностьПринял, НСтр("ru = '<Должность работника архива>'"));
		КонецЕсли;
		ОбластьПодвалПринял.Параметры.ДатаПриемки = 
			?(ЗначениеЗаполнено(ВыборкаСсылка.ДатаПриемки), Формат(ВыборкаСсылка.ДатаПриемки, "ДЛФ=D"),
				НСтр("ru = '<Дата приемки>'"));
		ОбластьПодвалПринял.Параметры.КоличествоДел = КоличествоЕдиницСтрокой;
		ТабличныйДокумент.Вывести(ОбластьПодвалПринял);
		
		// В табличном документе зададим имя области в которую был 
		// выведен объект. Нужно для возможности печати по-комплектно.
		УправлениеПечатью.ЗадатьОбластьПечатиДокумента(ТабличныйДокумент, НомерСтрокиНачало, ОбъектыПечати, ВыборкаСсылка.Ссылка);
	КонецЦикла;
	
	Возврат ТабличныйДокумент;
КонецФункции

#Область ОбработчикиСобытийЭлементовФормы

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	ДополнительныеСведения = ТекущийОбъект.ДополнительныеСведения;
	ДополнительныеСведения = СтрЗаменить(ДополнительныеСведения, "\n", Символы.ПС);
	ДополнительныеСведения = СтрЗаменить(ДополнительныеСведения, "\u0009", Символы.Таб);
КонецПроцедуры

&НаКлиенте
Процедура СообщениеОткрытие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	АдресВХранилище = АдресФайлаСообщенияВоВременномХранилище(Запись.Узел, Запись.Сообщение);
	ПолучаемыеФайлы = Новый Массив;
	ПолучаемыеФайлы.Добавить(Новый ОписаниеПередаваемогоФайла(Запись.Сообщение + ".json", АдресВХранилище));
	ОписаниеОповещения = Новый ОписаниеОповещения("СообщениеОткрытиеПослеПолучения", ЭтаФорма);
	НачатьПолучениеФайлов(ОписаниеОповещения, ПолучаемыеФайлы,, Истина);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура СообщениеОткрытиеПослеПолучения(Результат, ПараметрыОповещения) Экспорт
	
	ПроходитАПК = Истина;
	
КонецПроцедуры

&НаСервере
Функция АдресФайлаСообщенияВоВременномХранилище(Узел, Сообщение)
	
	НастройкиТранспорта = РегистрыСведений.НастройкиТранспортаКОД.Получить(Новый Структура("Узел", Узел));
	Настройки = НастройкиТранспорта.Настройки.Получить();
	ПолноеИмяФайлаСообщения = ОбщегоНазначенияКлиентСервер.ДобавитьКонечныйРазделительПути(Настройки.ОбщийКаталог)
		+ Сообщение + ".json";
	Файл = Новый Файл(ПолноеИмяФайлаСообщения); 
	Если Не Файл.Существует() Тогда
		КаталогОбработанных = ОбщегоНазначенияКлиентСервер.ДобавитьКонечныйРазделительПути(Настройки.ОбщийКаталог)
			+ ОбщегоНазначенияКлиентСервер.ДобавитьКонечныйРазделительПути("processed");
		Позиция = СтрНайти(Сообщение, "at");
		Год = Сред(Сообщение, Позиция + 2, 4);
		Месяц = Сред(Сообщение, Позиция + 6, 2);
		День = Сред(Сообщение, Позиция + 8, 2);
		КаталогГода = ОбщегоНазначенияКлиентСервер.ДобавитьКонечныйРазделительПути(КаталогОбработанных + Год);
		КаталогМесяца = ОбщегоНазначенияКлиентСервер.ДобавитьКонечныйРазделительПути(КаталогГода + Месяц);
		КаталогДня = ОбщегоНазначенияКлиентСервер.ДобавитьКонечныйРазделительПути(КаталогМесяца + День);
		ПолноеИмяФайлаСообщения = КаталогДня + Сообщение + ".json";
		Файл = Новый Файл(ПолноеИмяФайлаСообщения); 
		Если Не Файл.Существует() Тогда
			ВызватьИсключение НСтр("ru = 'Сообщение не найдено'");
		КонецЕсли;
	КонецЕсли;
	
	Адрес = ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(ПолноеИмяФайлаСообщения));
	
	Возврат Адрес;
	
КонецФункции

#КонецОбласти
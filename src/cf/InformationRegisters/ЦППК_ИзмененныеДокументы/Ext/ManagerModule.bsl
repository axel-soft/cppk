#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Добавляет запись в регистр измененных документов
//
// Параметры:
//  Документ - СправочникСсылка.ДокументыПредприятия - новый документ
//  ИзменяемыйДокумент - СправочникСсылка.ДокументыПредприятия - изменяемый документ
//  ДатаИзменения - Дата - дата отмены документа
Процедура ЗаписатьДанные(Документ, ИзменяемыйДокумент, ДатаИзменения) Экспорт
    УстановитьПривилегированныйРежим(Истина);
    
    Запись = РегистрыСведений.ЦППК_ИзмененныеДокументы.СоздатьМенеджерЗаписи();
    Запись.Документ = Документ;
    Запись.ИзменяемыйДокумент = ИзменяемыйДокумент;
    Запись.ДатаИзменения = ДатаИзменения;
    Запись.Записать();
КонецПроцедуры

// Удаляет запись из регистра измененных документов
//
// Параметры:
//  Документ - СправочникСсылка.ДокументыПредприятия - новый документ
//  ИзменяемыйДокумент - СправочникСсылка.ДокументыПредприятия - изменяемый документ
Процедура УдалитьДанные(Документ, ИзменяемыйДокумент) Экспорт
    УстановитьПривилегированныйРежим(Истина);
    
    Запись = РегистрыСведений.ЦППК_ИзмененныеДокументы.СоздатьМенеджерЗаписи();
    Запись.Документ = Документ;
    Запись.ИзменяемыйДокумент = ИзменяемыйДокумент;
    Запись.Удалить();
КонецПроцедуры

// Возвращает документы, которые отменяют указанный документ
//
// Параметры:
//  Документ - СправочникСсылка.ДокументыПредприятия - изменяемый документ
//
// Возвращаемое значение:
//  Массив Структур:
//    * Документ - СправочникСсылка.ДокументыПредприятия - новый документ
//    * ДатаИзменения - Дата - дата отмены документа
Функция ПрочитатьДанные(Документ) Экспорт
    Возврат ВыполнитьЗапросКРегистру(
        "ЦППК_ИзмененныеДокументы.Документ = &Документ",
        "Документ", Документ,
        Истина // Возвращать отменяемые документы
    );
КонецФункции

// Возвращает документы, отмененные указанным документом
//
// Параметры:
//  ИзменяемыйДокумент - СправочникСсылка.ДокументыПредприятия - новый документ
//
// Возвращаемое значение:
//  Массив Структур:
//    * Документ - СправочникСсылка.ДокументыПредприятия - изменяемый документ
//    * ДатаИзменения - Дата - дата отмены документа
Функция ПрочитатьНовыеДокументы(ИзменяемыйДокумент) Экспорт
    Возврат ВыполнитьЗапросКРегистру(
        "ЦППК_ИзмененныеДокументы.ИзменяемыйДокумент = &ИзменяемыйДокумент",
        "ИзменяемыйДокумент", ИзменяемыйДокумент,
        Ложь // Возвращать новые документы
    );
КонецФункции

#КонецОбласти

// Вспомогательная функция для выполнения запросов к регистру
//
// Параметры:
//  Условие - Строка - условие WHERE для запроса
//  ИмяПараметра - Строка - имя параметра запроса
//  ЗначениеПараметра - Произвольный - значение параметра
//  ВозвращатьОтменяемые - Булево - флаг направления связи
//
// Возвращаемое значение:
//  Массив Структур с данными документов
Функция ВыполнитьЗапросКРегистру(Условие, ИмяПараметра, ЗначениеПараметра, ВозвращатьОтменяемые)
    
    УстановитьПривилегированныйРежим(Истина);
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    ЦППК_ИзмененныеДокументы.Документ КАК Документ,
    |    ЦППК_ИзмененныеДокументы.ИзменяемыйДокумент КАК ИзменяемыйДокумент,
    |    ЦППК_ИзмененныеДокументы.ДатаИзменения КАК ДатаИзменения
    |ИЗ
    |    РегистрСведений.ЦППК_ИзмененныеДокументы КАК ЦППК_ИзмененныеДокументы
    |ГДЕ
    |    " + Условие;
    
    Запрос.УстановитьПараметр(ИмяПараметра, ЗначениеПараметра);
    
    Результат = Запрос.Выполнить().Выгрузить();
    МассивДокументов = Новый Массив;
    
    Для Каждого СтрокаРезультата Из Результат Цикл
        Документ = ?(ВозвращатьОтменяемые, 
            СтрокаРезультата.ИзменяемыйДокумент, 
            СтрокаРезультата.Документ);
            
        Элемент = Новый Структура("Документ, ДатаИзменения", 
            Документ, 
            СтрокаРезультата.ДатаИзменения);
            
        МассивДокументов.Добавить(Элемент);
    КонецЦикла;
    
    Возврат МассивДокументов;
КонецФункции

#КонецЕсли
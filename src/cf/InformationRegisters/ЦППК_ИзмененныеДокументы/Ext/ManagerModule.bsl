#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Добавляет запись в регистр измененных документов
//
// Параметры:
//  Документ - СправочникСсылка.ДокументыПредприятия - новый документ
//  ОтменяемыйДокумент - СправочникСсылка.ДокументыПредприятия - отменяемый документ
//  ДатаОтмены - Дата - дата отмены документа
Процедура ЗаписатьДанные(Документ, ОтменяемыйДокумент, ДатаОтмены) Экспорт
    УстановитьПривилегированныйРежим(Истина);
    
    Запись = РегистрыСведений.ЦППК_ИзмененныеДокументы.СоздатьМенеджерЗаписи();
    Запись.Документ = Документ;
    Запись.ОтменяемыйДокумент = ОтменяемыйДокумент;
    Запись.ДатаОтмены = ДатаОтмены;
    Запись.Записать();
КонецПроцедуры

// Удаляет запись из регистра измененных документов
//
// Параметры:
//  Документ - СправочникСсылка.ДокументыПредприятия - новый документ
//  ОтменяемыйДокумент - СправочникСсылка.ДокументыПредприятия - отменяемый документ
Процедура УдалитьДанные(Документ, ОтменяемыйДокумент) Экспорт
    УстановитьПривилегированныйРежим(Истина);
    
    Запись = РегистрыСведений.ЦППК_ИзмененныеДокументы.СоздатьМенеджерЗаписи();
    Запись.Документ = Документ;
    Запись.ОтменяемыйДокумент = ОтменяемыйДокумент;
    Запись.Удалить();
КонецПроцедуры

// Возвращает документы, которые отменяют указанный документ
//
// Параметры:
//  Документ - СправочникСсылка.ДокументыПредприятия - отменяемый документ
//
// Возвращаемое значение:
//  Массив Структур:
//    * Документ - СправочникСсылка.ДокументыПредприятия - новый документ
//    * ДатаОтмены - Дата - дата отмены документа
Функция ПрочитатьДанные(Документ) Экспорт
    Возврат ВыполнитьЗапросКРегистру(
        "ЦППК_ИзмененныеДокументы.Документ = &Документ",
        "Документ", Документ,
        Истина // Возвращать отменяемые документы
    );
КонецФункции

// Возвращает документы, отмененные указанным документом
//
// Параметры:
//  ОтменяемыйДокумент - СправочникСсылка.ДокументыПредприятия - новый документ
//
// Возвращаемое значение:
//  Массив Структур:
//    * Документ - СправочникСсылка.ДокументыПредприятия - отменяемый документ
//    * ДатаОтмены - Дата - дата отмены документа
Функция ПрочитатьНовыеДокументы(ОтменяемыйДокумент) Экспорт
    Возврат ВыполнитьЗапросКРегистру(
        "ЦППК_ИзмененныеДокументы.ОтменяемыйДокумент = &ОтменяемыйДокумент",
        "ОтменяемыйДокумент", ОтменяемыйДокумент,
        Ложь // Возвращать новые документы
    );
КонецФункции

#КонецОбласти

// Вспомогательная функция для выполнения запросов к регистру
//
// Параметры:
//  Условие - Строка - условие WHERE для запроса
//  ИмяПараметра - Строка - имя параметра запроса
//  ЗначениеПараметра - Произвольный - значение параметра
//  ВозвращатьОтменяемые - Булево - флаг направления связи
//
// Возвращаемое значение:
//  Массив Структур с данными документов
Функция ВыполнитьЗапросКРегистру(Условие, ИмяПараметра, ЗначениеПараметра, ВозвращатьОтменяемые)
    
    УстановитьПривилегированныйРежим(Истина);
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    ЦППК_ИзмененныеДокументы.Документ КАК Документ,
    |    ЦППК_ИзмененныеДокументы.ОтменяемыйДокумент КАК ОтменяемыйДокумент,
    |    ЦППК_ИзмененныеДокументы.ДатаОтмены КАК ДатаОтмены
    |ИЗ
    |    РегистрСведений.ЦППК_ИзмененныеДокументы КАК ЦППК_ИзмененныеДокументы
    |ГДЕ
    |    " + Условие;
    
    Запрос.УстановитьПараметр(ИмяПараметра, ЗначениеПараметра);
    
    Результат = Запрос.Выполнить().Выгрузить();
    МассивДокументов = Новый Массив;
    
    Для Каждого СтрокаРезультата Из Результат Цикл
        Документ = ?(ВозвращатьОтменяемые, 
            СтрокаРезультата.ОтменяемыйДокумент, 
            СтрокаРезультата.Документ);
            
        Элемент = Новый Структура("Документ, ДатаОтмены", 
            Документ, 
            СтрокаРезультата.ДатаОтмены);
            
        МассивДокументов.Добавить(Элемент);
    КонецЦикла;
    
    Возврат МассивДокументов;
КонецФункции

#КонецЕсли